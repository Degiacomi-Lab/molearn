
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>molearn.loss_functions.openmm_thread &#8212; molearn 1.3.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">molearn 1.3.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">molearn.loss_functions.openmm_thread</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for molearn.loss_functions.openmm_thread</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="c1">#from openmm.unit import kelvin, picosecond</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">openmm</span> <span class="kn">import</span> <span class="n">Platform</span>
    <span class="kn">from</span> <span class="nn">openmm.app</span> <span class="kn">import</span> <span class="n">ForceField</span><span class="p">,</span> <span class="n">PDBFile</span><span class="p">,</span> <span class="n">Simulation</span> <span class="c1">#, OBC2</span>
    <span class="kn">from</span> <span class="nn">openmm.app</span> <span class="kn">import</span> <span class="n">element</span> <span class="k">as</span> <span class="n">elem</span>
    <span class="kn">import</span> <span class="nn">openmm</span>
    <span class="kn">from</span> <span class="nn">openmm.app.forcefield</span> <span class="kn">import</span> <span class="n">_createResidueSignature</span>
    <span class="kn">from</span> <span class="nn">openmm.app.internal</span> <span class="kn">import</span> <span class="n">compiled</span>
    <span class="kn">from</span> <span class="nn">torchexposedintegratorplugin</span> <span class="kn">import</span> <span class="n">TorchExposedIntegrator</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">. Will not be able to use openmm.&#39;</span><span class="p">)</span>
    
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#from math import ceil</span>


<div class="viewcode-block" id="ModifiedForceField"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.ModifiedForceField">[docs]</a><span class="k">class</span> <span class="nc">ModifiedForceField</span><span class="p">(</span><span class="n">ForceField</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">alternative_residue_names</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alternative_residue_names</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alternative_residue_names</span> <span class="o">=</span> <span class="n">alternative_residue_names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alternative_residue_names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;HIS&#39;</span><span class="p">:</span><span class="s1">&#39;HIE&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_getResidueTemplateMatches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">templateSignatures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignoreExtraParticles</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the templates that match a residue, or None if none are found.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        res : Topology.Residue</span>
<span class="sd">            The residue for which template matches are to be retrieved.</span>
<span class="sd">        bondedToAtom : list of set of int</span>
<span class="sd">            bondedToAtom[i] is the set of atoms bonded to atom index i</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        template : _TemplateData</span>
<span class="sd">            The matching forcefield residue template, or None if no matches are found.</span>
<span class="sd">        matches : list</span>
<span class="sd">            a list specifying which atom of the template each atom of the residue</span>
<span class="sd">            corresponds to, or None if it does not match the template</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">matcher</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templateMatchers</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">matcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">,</span> <span class="n">ignoreExtraParticles</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">matchResidueToTemplate</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">,</span> <span class="n">ignoreExtraParticles</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A custom template matcher returned a template for residue </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">), but it does not match the residue.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">match</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">templateSignatures</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">templateSignatures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templateSignatures</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">_createResidueSignature</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">()])</span>
        <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="n">templateSignatures</span><span class="p">:</span>
            <span class="n">allMatches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">templateSignatures</span><span class="p">[</span><span class="n">signature</span><span class="p">]:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">matchResidueToTemplate</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">,</span> <span class="n">ignoreExtraParticles</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">allMatches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">match</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">allMatches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">allMatches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allMatches</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternative_residue_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">template</span> <span class="o">=</span> <span class="n">t</span>
                        <span class="n">matches</span> <span class="o">=</span> <span class="n">m</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s1">&#39;N&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">==</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1">, is a being set as a N terminal residue&#39;</span><span class="p">)</span>
                        <span class="n">template</span> <span class="o">=</span> <span class="n">t</span>
                        <span class="n">matches</span> <span class="o">=</span> <span class="n">m</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s1">&#39;C&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">==</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="si">}</span><span class="s1"> is a being set as a C terminal residue&#39;</span><span class="p">)</span>
                        <span class="n">template</span> <span class="o">=</span> <span class="n">t</span>
                        <span class="n">matches</span> <span class="o">=</span> <span class="n">m</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;multpile for </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># We found multiple matches.  This is OK if and only if they assign identical types and parameters to all atoms.</span>
                <span class="n">t1</span><span class="p">,</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">t2</span><span class="p">,</span> <span class="n">m2</span> <span class="ow">in</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">t1</span><span class="o">.</span><span class="n">areParametersIdentical</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Multiple non-identical matching templates found for residue </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">): </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">allMatches</span><span class="p">)))</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span></div>

<div class="viewcode-block" id="OpenmmPluginScore"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.OpenmmPluginScore">[docs]</a><span class="k">class</span> <span class="nc">OpenmmPluginScore</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This will use the new Openmm Plugin to calculate forces and energy. The intention is that this will be fast enough to be able to calculate forces and energy during training.</span>
<span class="sd">    NB. The current torchintegratorplugin only supports float on GPU and double on CPU.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xml_file</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;amber14-all.xml&#39;</span><span class="p">],</span> <span class="n">platform</span> <span class="o">=</span> <span class="s1">&#39;CUDA&#39;</span><span class="p">,</span> <span class="n">remove_NB</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alternative_residue_names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">HIS</span><span class="o">=</span><span class="s1">&#39;HIE&#39;</span><span class="p">,</span> <span class="n">HSE</span><span class="o">=</span><span class="s1">&#39;HIE&#39;</span><span class="p">),</span> <span class="n">atoms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span>
                                                                                                                                                                              <span class="s1">&#39;CB&#39;</span><span class="p">,</span>
                                                                                                                                                                              <span class="s1">&#39;O&#39;</span><span class="p">],</span>
                <span class="n">soft</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param mol: (biobox.Molecule, default None) If pldataloader is not given, then a biobox object will be taken from this parameter. If neither are given then an error  will be thrown.</span>
<span class="sd">        :param data_dir: (string, default None) if pldataloader is not given then this will be used to find files such as &#39;variants.npy&#39;</span>
<span class="sd">        :param xml_file: (string, default: &quot;amber14-all.xml&quot;) xml parameter file</span>
<span class="sd">        :param platform: (string, default &#39;CUDA&#39;) either &#39;CUDA&#39; or &#39;Reference&#39;.</span>
<span class="sd">        :param remove_NB: (bool, default False) remove NonbondedForce, CustomGBForce, CMMotionRemover else just remove CustomGBForce</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">alternative_residue_names</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#self.mol.data.loc[:,&#39;resname&#39;][self.mol.data[&#39;resname&#39;]==key]=value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;resname&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">,</span><span class="s1">&#39;resname&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>
            <span class="c1">#self.mol.data.loc[lambda df: df[&#39;resname&#39;]==key, key]=value</span>
        <span class="n">tmp_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;tmp</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mf">1e10</span><span class="p">)</span><span class="si">}</span><span class="s1">.pdb&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">write_pdb</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span> <span class="o">=</span> <span class="n">PDBFile</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">soft</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;attempting soft forcefield&#39;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">pdbfixer</span> <span class="kn">import</span> <span class="n">PDBFixer</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">PDBFixer</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">_createForceField</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xml_file</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span> <span class="o">=</span> <span class="n">ModifiedForceField</span><span class="p">(</span><span class="n">xml_file</span><span class="p">,</span> <span class="n">alternative_residue_names</span> <span class="o">=</span> <span class="n">alternative_residue_names</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">xml_file</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span> <span class="o">=</span> <span class="n">ModifiedForceField</span><span class="p">(</span><span class="o">*</span><span class="n">xml_file</span><span class="p">,</span> <span class="n">alternative_residue_names</span> <span class="o">=</span> <span class="n">alternative_residue_names</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xml_file: </span><span class="si">{</span><span class="n">xml_file</span><span class="si">}</span><span class="s1"> needs to be a str or a list of str&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">atoms</span> <span class="o">==</span> <span class="s1">&#39;no_hydrogen&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ignore_hydrogen</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
            <span class="c1">#save pdb and reload in modeller</span>
            <span class="n">templates</span><span class="p">,</span> <span class="n">unique_unmatched_residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">generateTemplatesForUnmatchedResidues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_NB</span><span class="p">:</span>
                <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">getForces</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forces</span><span class="p">))):</span>
                    <span class="n">force</span> <span class="o">=</span> <span class="n">forces</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="p">(</span><span class="c1">#openmm.PeriodicTorsionForce,</span>
                                          <span class="n">openmm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="p">,</span>
                                          <span class="n">openmm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">,</span>
                                          <span class="n">openmm</span><span class="o">.</span><span class="n">CMMotionRemover</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">removeForce</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">getForces</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forces</span><span class="p">))):</span>
                    <span class="n">force</span> <span class="o">=</span> <span class="n">forces</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">removeForce</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">TorchExposedIntegrator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;CUDA&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getSystem</span><span class="p">()</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_energy</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">ignore_hydrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#ignore = [&#39;ASH&#39;, &#39;LYN&#39;, &#39;GLH&#39;, &#39;HID&#39;, &#39;HIP&#39;, &#39;CYM&#39;, ]</span>
        <span class="n">ignore</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">_templates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">patchData</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchData</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_remove_h&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="p">:</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">atomDescription</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">deletedAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomDescription</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="n">atom1</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">atom2</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span> <span class="ow">or</span> <span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span><span class="p">:</span>
                    <span class="n">a1</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">a2</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">patchData</span><span class="o">.</span><span class="n">deletedBonds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">registerTemplatePatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;_remove_h&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">registerPatch</span><span class="p">(</span><span class="n">patchData</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">atomselect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">_templates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">patchData</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchData</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_leave_only_&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atoms</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="p">:</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">atomDescription</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">patchData</span><span class="o">.</span><span class="n">deletedAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomDescription</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="n">atom1</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">atom2</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="ow">or</span> <span class="n">atom2</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                    <span class="n">a1</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">a2</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">patchData</span><span class="o">.</span><span class="n">deletedBonds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">registerTemplatePatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;_leave_only_&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atoms</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">registerPatch</span><span class="p">(</span><span class="n">patchData</span><span class="p">)</span>


<div class="viewcode-block" id="OpenmmPluginScore.get_energy"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.OpenmmPluginScore.get_energy">[docs]</a>    <span class="k">def</span> <span class="nf">get_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos_ptr</span><span class="p">,</span> <span class="n">force_ptr</span><span class="p">,</span> <span class="n">energy_ptr</span><span class="p">,</span> <span class="n">n_particles</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param pos_ptr: tensor.data_ptr()</span>
<span class="sd">        :param force_ptr: tensor.data_ptr()</span>
<span class="sd">        :param energy_ptr: tensor.data_ptr()</span>
<span class="sd">        :param n_particles: int</span>
<span class="sd">        :param batch_size: int</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">n_particles</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">torchMultiStructureE</span><span class="p">(</span><span class="n">pos_ptr</span><span class="p">,</span> <span class="n">force_ptr</span><span class="p">,</span> <span class="n">energy_ptr</span><span class="p">,</span> <span class="n">n_particles</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="OpenmmPluginScore.execute"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.OpenmmPluginScore.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param x: torch tensor shape [b, N, 3]. dtype=float. device = gpu</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_energy</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">force</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">energy</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">force</span><span class="p">,</span> <span class="n">energy</span></div></div>


<div class="viewcode-block" id="OpenmmTorchEnergyMinimizer"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.OpenmmTorchEnergyMinimizer">[docs]</a><span class="k">class</span> <span class="nc">OpenmmTorchEnergyMinimizer</span><span class="p">(</span><span class="n">OpenmmPluginScore</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">minimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">maxIterations</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">minimized_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="n">force</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">abs_max</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxIterations</span><span class="p">):</span>
                <span class="n">new_s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">force</span><span class="o">*</span><span class="n">abs_max</span><span class="o">*</span><span class="n">h</span>
                <span class="n">new_force</span><span class="p">,</span> <span class="n">new_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">new_s</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_energy</span><span class="o">&lt;</span><span class="n">energy</span><span class="p">:</span>
                    <span class="n">s</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">force</span> <span class="o">=</span> <span class="n">new_s</span><span class="p">,</span> <span class="n">new_energy</span><span class="p">,</span> <span class="n">new_force</span>
                    <span class="k">if</span> <span class="n">energy</span><span class="o">&lt;</span><span class="n">threshold</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">h</span><span class="o">*=</span><span class="mf">1.2</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">h</span><span class="o">*=</span><span class="mf">0.2</span>
            <span class="n">minimized_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">s</span>
        <span class="k">return</span> <span class="n">minimized_x</span></div>



<div class="viewcode-block" id="OpenMMPluginScoreSoftForceField"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.OpenMMPluginScoreSoftForceField">[docs]</a><span class="k">class</span> <span class="nc">OpenMMPluginScoreSoftForceField</span><span class="p">(</span><span class="n">OpenmmPluginScore</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;CUDA&#39;</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="s1">&#39;CB&#39;</span><span class="p">,</span><span class="s1">&#39;O&#39;</span><span class="p">,]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span>
        <span class="n">tmp_file</span> <span class="o">=</span> <span class="s1">&#39;tmp.pdb&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">write_pdb</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span> <span class="o">=</span> <span class="n">PDBFile</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">pdbfixer</span> <span class="kn">import</span> <span class="n">PDBFixer</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">PDBFixer</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">_createForceField</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">TorchExposedIntegrator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;CUDA&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getSystem</span><span class="p">()</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_energy</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="openmm_energy_function"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.openmm_energy_function">[docs]</a><span class="k">class</span> <span class="nc">openmm_energy_function</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>

<div class="viewcode-block" id="openmm_energy_function.forward"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.openmm_energy_function.forward">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param plugin: # OpenmmPluginScore instance</span>
<span class="sd">        :param x: torch tensor, dtype = float, shape = [B, N, 3], device = any</span>
<span class="sd">        :returns: energy tensor, dtype = float, shape = [B], device  = any</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">plugin</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getForces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">force</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getForces</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">_value</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">force</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#torch.cuda.synchronize(x.device)</span>
            <span class="n">force</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="c1">#torch.cuda.synchronize(x.device)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">energy</span></div>

<div class="viewcode-block" id="openmm_energy_function.backward"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.openmm_energy_function.backward">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">grad_output</span><span class="p">):</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">saved_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># force shape [B, N, 3]</span>
        <span class="c1">#embed(header=&#39;23 openmm_loss_function&#39;)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="n">force</span><span class="o">*</span><span class="n">grad_output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="openmm_clamped_energy_function"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.openmm_clamped_energy_function">[docs]</a><span class="k">class</span> <span class="nc">openmm_clamped_energy_function</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>

<div class="viewcode-block" id="openmm_clamped_energy_function.forward"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.openmm_clamped_energy_function.forward">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">clamp</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param plugin: # OpenmmPluginScore instance</span>
<span class="sd">        :param x: torch tensor, dtype = float, shape = [B, N, 3], device = Cuda</span>
<span class="sd">        :returns: energy tensor, dtype = double, shape = [B], device CPU</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">plugin</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getForces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">force</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getForces</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">_value</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">force</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">force</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="o">**</span><span class="n">clamp</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">energy</span></div>

<div class="viewcode-block" id="openmm_clamped_energy_function.backward"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.openmm_clamped_energy_function.backward">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">grad_output</span><span class="p">):</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">saved_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="n">force</span><span class="o">*</span><span class="n">grad_output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="kc">None</span></div></div>

<div class="viewcode-block" id="openmm_energy"><a class="viewcode-back" href="../../../loss_functions.html#molearn.loss_functions.openmm_thread.openmm_energy">[docs]</a><span class="k">class</span> <span class="nc">openmm_energy</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">clamp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openmmplugin</span> <span class="o">=</span> <span class="n">OpenmmPluginScore</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">std</span><span class="o">/</span><span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clamp</span> <span class="o">=</span> <span class="n">clamp</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clamp_forward</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span>

    <span class="k">def</span> <span class="nf">_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param x: torch tensor dtype=torch.float, device=CUDA, shape B, 3, N </span>
<span class="sd">        :returns: torch energy tensor dtype should be float and on same device as x</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">openmm_energy_function</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openmmplugin</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">energy</span>

    <span class="k">def</span> <span class="nf">_clamp_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param x: torch tensor dtype=torch.float, device=CUDA, shape B, 3, N </span>
<span class="sd">        :returns: torch energy tensor dtype should be float and on same device as x</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">openmm_clamped_energy_function</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openmmplugin</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clamp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">energy</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">molearn 1.3.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">molearn.loss_functions.openmm_thread</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, V. K. Ramaswamy, S. C. Musson, M. T. Degiacomi.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>
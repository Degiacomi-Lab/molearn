
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>torch_potential.protein_handler &#8212; molearn 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">molearn 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">torch_potential.protein_handler</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for torch_potential.protein_handler</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2021 Venkata K. Ramaswamy, Samuel C. Musson, Matteo T. Degiacomi</span>
<span class="c1">#</span>
<span class="c1"># Molearn is free software ;</span>
<span class="c1"># you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation ;</span>
<span class="c1"># either version 2 of the License, or (at your option) any later version.</span>
<span class="c1"># BiobOx is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY ;</span>
<span class="c1"># without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="c1"># See the GNU General Public License for more details.</span>
<span class="c1"># You should have received a copy of the GNU General Public License along with BiobOx ;</span>
<span class="c1"># if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">biobox</span>

<div class="viewcode-block" id="load_data"><a class="viewcode-back" href="../../molearn.html#torch_potential.load_data">[docs]</a><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">f_name</span><span class="o">=</span><span class="s1">&#39;test.pdb&#39;</span> <span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;CB&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">],</span>
        <span class="n">restart</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dataset_sample_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">get_crds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">padded_residues</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">get_name_resname</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">get_max_rmsd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">get_bb_mol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">),</span>
             <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function will load and prepare data from a pdb file returning the data as a tuple of of the coordinates, dataset std, dataset mean.</span>

<span class="sd">    The coordinates of the dataset will be centered around the mean and scaled by the std ``(dataset-dataset.mean())/dataset.std()``. Coordinates are usually represented in an array shape [B, N,</span>
<span class="sd">    3] where B is the number of conformations, N is the number of atoms and 3 is the dimensionality of the data (here cartesian). We permute the data to be shape [B, 3, N] so that we have 1D data</span>
<span class="sd">    with 3 channels for ML applications.</span>

<span class="sd">    Function has a number of additional options:</span>

<span class="sd">    * load/save a file *dataset_conformations.npy* containing the conformations of the loaded dataset to allow restarting or custom subsets of the dataset to be used.</span>
<span class="sd">    * determine the two structure with the largest disimilarity (determined with RMSD) and return them as ``torch.tensor`` arrays.</span>
<span class="sd">      These can be used as text cases to interpolate between the most extreme examples</span>
<span class="sd">    * return the ``biobox.molecule`` used to load the data</span>
<span class="sd">    * return the pdb atom and residue names</span>
<span class="sd">    * reformat the data by padded residues shape [B, R, M, 3].</span>

<span class="sd">    :param f_name: path / filename for the .pdb dataset</span>
<span class="sd">    :param atoms: PDB atom names in a list of strings ``[&quot;CA&quot;, &quot;C&quot;, &quot;N&quot;, &quot;CB&quot;, &quot;O&quot;]``. ``&quot;*&quot;`` for all atoms.</span>
<span class="sd">        ``biobox.molecule.atomselect`` of only these atoms will return the coordinates corresponding to these atoms.</span>
<span class="sd">    :param restart: If true, the loaded pdb conformations will be indexed with the contents of *dataset_conformations.npy* before being returned.</span>

<span class="sd">        If false, ``B = dataset_sample_size`` conformations will be randomly selected and returned. The indexes of the conformations with respect to the original pdb file will be saved to</span>
<span class="sd">        ``dataset_conformations.npy``.</span>

<span class="sd">        If the same random subset of conformations is needed again then set ``restart = True``.</span>
<span class="sd">    :param dataset_sample_size: A random selection of ``dataset_sample_size`` (int) conformations will be returned. If ``dataset_sample_size = -1`` Then all conformations will be returned in the same order as in the pdb file.</span>
<span class="sd">    :param get_crds: If true the first three items of the returned tuple will be the scaled dataset (``shape [Batchsize, 3, Number of atoms]``), dataset *mean*, and the dataset *std*. Original</span>
<span class="sd">        dataset can be recovered with ``dataset*std+mean``.</span>
<span class="sd">    :param padded_residues: If True the returned dataset will be of shape [B, R, M, 3] where B is the number of conformations, R is the number of residues, M is the maximum number of</span>
<span class="sd">        atoms per residue, 3 corresponds to the cartesian coordinates. The dataset is ``np.nan`` padded where required.\n</span>
<span class="sd">        If false, the returned dataset will be of shape [B, 3, N]. Whele B is the number of conformations, and N is the number of atoms.</span>
<span class="sd">    :param get_name_resname: If true will append to the returned tuple  [PDB atom name (``String``), residue name (``String``)] for each atom shape = [N, 2]</span>
<span class="sd">    :param get_bb_mol: If True, will append to the returned tuple the biobox Molecule object used to produce this data.</span>
<span class="sd">    :param get_max_rmsd: If True, calculates the rmsd of each conformation against each other then appends to the returned tuple two ``torch.tensor`` arrays (TEST1, TEST0) corresponding to the frames with the highest rmsd.</span>

<span class="sd">    :returns: **tuple** containing:</span>

<span class="sd">        * ``torch.tensor`` dataset (if ``get_crds=True``)</span>

<span class="sd">          * shape [B, 3, N] (``padded_residues = False``)</span>
<span class="sd">          * shape [B, R, M, 3] (``padded_residues = True``)</span>

<span class="sd">        * ``float`` dataset mean (if ``get_crds=True``)</span>
<span class="sd">        * ``float`` dataset std (if ``get_crds=True``)</span>
<span class="sd">        * ``numpy.array`` atoms names and atom residues shape [N, 2] (if ``get_name_resname=True``)</span>
<span class="sd">        * ``biobox.molecule`` object used to load data (if ``get_bb_mol``)</span>
<span class="sd">        * ``torch.tensor`` TEST0 shape [3, N] (if ``get_max_rmsd``)</span>
<span class="sd">        * ``torch.tensor`` TEST1 shape [3, N] (if ``get_max_rmsd``)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#loading dataset</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">biobox</span><span class="o">.</span><span class="n">Molecule</span><span class="p">()</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">import_pdb</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">idxs</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">atoms</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
        <span class="c1">#list like default above of atom names</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">restart</span><span class="p">:</span>
        <span class="n">conformations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;dataset_conformations.npy&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dataset_sample_size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">conformations</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># all frames/conformations in the dataset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conformations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:</span><span class="n">dataset_sample_size</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;dataset_conformations.npy&#39;</span><span class="p">,</span><span class="n">conformations</span><span class="p">)</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span><span class="n">conformations</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Conformations: (also saved to dataset_conformations.npy)&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span>


    <span class="c1"># crds shape [F, N, 3]</span>
    <span class="c1"># Following gets:</span>
    <span class="c1"># len(resids) = N; [1,1,1,...,437,437,437] does not index from 1 </span>
    <span class="c1"># unique.shape = [R,], count of each unique number</span>
    <span class="n">resids</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;resid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">resids</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>


    <span class="n">to_return</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">##########  get coordinates, meanval, stdval  ##########</span>
    <span class="k">if</span> <span class="n">get_crds</span><span class="p">:</span>
        <span class="n">crds</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">meanval</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">stdval</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">crds</span> <span class="o">=</span> <span class="p">(</span><span class="n">crds</span><span class="o">-</span><span class="n">meanval</span><span class="p">)</span><span class="o">/</span><span class="n">stdval</span>
        <span class="k">if</span> <span class="n">padded_residues</span><span class="p">:</span>
            <span class="c1"># dataset.shape = [F, R, M, 3] </span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">crds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unique</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unique</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">total</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique</span><span class="p">):</span>
                <span class="n">dataset</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:</span><span class="n">count</span><span class="p">,:]</span><span class="o">=</span><span class="n">crds</span><span class="p">[:,</span><span class="n">total</span><span class="p">:</span><span class="n">total</span><span class="o">+</span><span class="n">count</span><span class="p">,:]</span>
                <span class="n">total</span><span class="o">+=</span><span class="n">count</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">crds</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">meanval</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">stdval</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">crds</span> <span class="o">=</span> <span class="p">(</span><span class="n">crds</span><span class="o">-</span><span class="n">meanval</span><span class="p">)</span><span class="o">/</span><span class="n">stdval</span>
            <span class="n">crdsflat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">crds</span><span class="p">,</span> <span class="p">(</span><span class="n">crds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">crds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">crds</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="c1"># dataset.shape [F, N, 3] -&gt; [F, 3, N]</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">to_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">to_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meanval</span><span class="p">)</span>
        <span class="n">to_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stdval</span><span class="p">)</span>
    <span class="c1">##########  get atom names and residue names  ##########</span>
    <span class="k">if</span> <span class="n">get_name_resname</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">padded_residues</span><span class="p">:</span>
            <span class="n">padded_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">unique</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unique</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;resname&#39;</span><span class="p">,</span> <span class="s1">&#39;resid&#39;</span><span class="p">])</span>
            <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique</span><span class="p">):</span>
                <span class="n">padded_names</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">count</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="n">total</span><span class="p">:</span><span class="n">total</span><span class="o">+</span><span class="n">count</span><span class="p">]</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">count</span>
            <span class="n">to_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;resname&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">get_bb_mol</span><span class="p">:</span>
        <span class="n">to_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">get_max_rmsd</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">idxs</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">conformations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:</span><span class="nb">min</span><span class="p">(</span><span class="n">dataset_sample_size</span><span class="p">,</span><span class="mi">1000</span><span class="p">)]</span> <span class="c1">#limit to 1000 structures otherwise it takes forever</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span><span class="n">conformations</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determine rmsd matrix&#39;</span><span class="p">)</span>
        <span class="n">rmsd_matrix</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">rmsd_distance_matrix</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rmsd calcs Done&#39;</span><span class="p">)</span>
        <span class="c1">#BxB matrix</span>
        <span class="c1">#arg max returns index in a flattened array, np.unravel_index recreates index</span>
        <span class="n">max_rmsd_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">rmsd_matrix</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">rmsd_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">test0</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">max_rmsd_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">test1</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">max_rmsd_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">to_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">test0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">to_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">test1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">to_return</span></div>

<span class="k">def</span> <span class="nf">read_lib_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">amber_atoms</span><span class="p">,</span> <span class="n">atom_charge</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./parameters/&#39;</span><span class="o">+</span><span class="n">file_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> opened&#39;</span> <span class="o">%</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: file </span><span class="si">%s</span><span class="s1"> not found!&#39;</span> <span class="o">%</span> <span class="n">file_name</span><span class="p">)</span>


    <span class="n">lines</span> <span class="o">=</span> <span class="n">f_in</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">tline</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tline</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">==</span><span class="p">[</span><span class="s1">&#39;!!index&#39;</span><span class="p">,</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">]:</span>
            <span class="n">depth</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">depth</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39; &#39;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="mi">5</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">res</span><span class="o">=</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&quot;&#39;</span> <span class="ow">and</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span><span class="s1">&#39;&quot;&#39;</span><span class="p">:</span>
                   <span class="n">amber_atoms</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="p">{}</span>
                   <span class="n">atom_charge</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="p">{}</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="k">raise</span> <span class="ne">Exception</span><span class="p">((</span><span class="s1">&#39;I was expecting something of the form&#39;</span>
                                       <span class="o">+</span><span class="s1">&#39;&quot;XXX&quot; but got </span><span class="si">%s</span><span class="s1"> instead&#39;</span> <span class="o">%</span> <span class="n">res</span><span class="p">))</span>
                <span class="n">depth</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">break</span>
        <span class="n">depth</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tline</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">entry</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">tline</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span><span class="n">tline</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="n">tline</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">22</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">entry</span><span class="o">==</span><span class="s1">&#39;!entry.&#39;</span> <span class="ow">and</span> <span class="n">section</span><span class="o">==</span><span class="s1">&#39;.unit.atoms &#39;</span><span class="p">:</span>
            <span class="n">depth</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">depth</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span> <span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39; &#39;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">4</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">pdb_name</span><span class="p">,</span> <span class="n">amber_name</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">charge</span> <span class="o">=</span> <span class="n">contents</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pdb_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&quot;&#39;</span> <span class="ow">and</span> <span class="n">pdb_name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&quot;&#39;</span>
                    <span class="ow">and</span> <span class="n">amber_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&quot;&#39;</span> <span class="ow">and</span> <span class="n">amber_name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
                    <span class="n">amber_atoms</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">atom_charge</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="n">amber_name</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">charge</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="k">raise</span> <span class="ne">Exception</span><span class="p">((</span><span class="s1">&#39;I was expecting something of the form&#39;</span>
                                       <span class="o">+</span><span class="s1">&#39;&quot;XXX&quot; but got </span><span class="si">%s</span><span class="s1"> instead&#39;</span> <span class="o">%</span> <span class="n">res</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_amber_parameters</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">file_names</span> <span class="o">=</span><span class="p">(</span><span class="s1">&#39;amino12.lib&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;parm10.dat&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;frcmod.ff14SB&#39;</span><span class="p">)</span>

              <span class="c1">#amber19 is dangerous because they&#39;ve replaced parameters with cmap</span>
    <span class="c1">###### pdb atom names to amber atom names using amino19.lib ######</span>
    <span class="n">amber_atoms</span>          <span class="o">=</span> <span class="p">{}</span> <span class="c1"># knowledge[res][pdb_atom] = amber_atom</span>
    <span class="n">atom_mass</span>            <span class="o">=</span> <span class="p">{}</span>
    <span class="n">atom_polarizability</span>  <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bond_force</span>           <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bond_equil</span>           <span class="o">=</span> <span class="p">{}</span>
    <span class="n">angle_force</span>          <span class="o">=</span> <span class="p">{}</span>
    <span class="n">angle_equil</span>          <span class="o">=</span> <span class="p">{}</span>
    <span class="n">torsion_factor</span>       <span class="o">=</span> <span class="p">{}</span>
    <span class="n">torsion_barrier</span>      <span class="o">=</span> <span class="p">{}</span>
    <span class="n">torsion_phase</span>        <span class="o">=</span> <span class="p">{}</span>
    <span class="n">torsion_period</span>       <span class="o">=</span> <span class="p">{}</span>
    <span class="n">improper_factor</span>      <span class="o">=</span> <span class="p">{}</span>
    <span class="n">improper_barrier</span>     <span class="o">=</span> <span class="p">{}</span>
    <span class="n">improper_phase</span>       <span class="o">=</span> <span class="p">{}</span>
    <span class="n">improper_period</span>      <span class="o">=</span> <span class="p">{}</span>

    <span class="n">other_parameters</span>     <span class="o">=</span> <span class="p">{}</span>
    <span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;vdw_potential_well_depth&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;H_bond_10_12_parameters&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;equivalences&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>

    <span class="n">read_lib_file</span><span class="p">(</span><span class="n">file_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">amber_atoms</span><span class="p">,</span><span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./parameters/&#39;</span><span class="o">+</span><span class="n">file_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> opened&#39;</span> <span class="o">%</span> <span class="n">file_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: file </span><span class="si">%s</span><span class="s1"> not found!&#39;</span> <span class="o">%</span> <span class="n">file_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1">#section 1 title</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f_in</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">amber_card_type_2</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">atom_mass</span><span class="p">,</span> <span class="n">atom_polarizability</span><span class="p">)</span>
    <span class="n">amber_card_type_3</span><span class="p">(</span><span class="n">f_in</span><span class="p">)</span>
    <span class="n">amber_card_type_4</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">bond_force</span><span class="p">,</span> <span class="n">bond_equil</span><span class="p">)</span>
    <span class="n">amber_card_type_5</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">angle_force</span><span class="p">,</span> <span class="n">angle_equil</span><span class="p">)</span>
    <span class="n">amber_card_type_6</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">torsion_factor</span><span class="p">,</span> <span class="n">torsion_barrier</span><span class="p">,</span> <span class="n">torsion_phase</span><span class="p">,</span> <span class="n">torsion_period</span><span class="p">)</span>
    <span class="n">amber_card_type_7</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">improper_factor</span><span class="p">,</span>
                      <span class="n">improper_barrier</span><span class="p">,</span> <span class="n">improper_phase</span><span class="p">,</span> <span class="n">improper_period</span><span class="p">)</span>
    <span class="n">amber_card_type_8</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">other_parameters</span><span class="p">)</span>
    <span class="n">amber_card_type_9</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">other_parameters</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;RE&#39;</span><span class="p">:</span>
                <span class="n">amber_card_type_10B</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">other_parameters</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;END&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;parameters loaded&#39;</span><span class="p">)</span>
    <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1">#open frcmod file, should be identifcal format but missing any or all cards</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./parameters/&#39;</span><span class="o">+</span><span class="n">file_names</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> opened&#39;</span> <span class="o">%</span> <span class="n">file_names</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: file </span><span class="si">%s</span><span class="s1"> not found!&#39;</span> <span class="o">%</span> <span class="n">file_names</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>


    <span class="c1">#section 1 title</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f_in</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;MASS&#39;</span><span class="p">:</span>
            <span class="n">amber_card_type_2</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">atom_mass</span><span class="p">,</span> <span class="n">atom_polarizability</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;BOND&#39;</span><span class="p">:</span>
            <span class="n">amber_card_type_4</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">bond_force</span><span class="p">,</span> <span class="n">bond_equil</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;ANGL&#39;</span><span class="p">:</span>
            <span class="n">amber_card_type_5</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">angle_force</span><span class="p">,</span> <span class="n">angle_equil</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;DIHE&#39;</span><span class="p">:</span>
            <span class="n">amber_card_type_6</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">torsion_factor</span><span class="p">,</span> <span class="n">torsion_barrier</span><span class="p">,</span> <span class="n">torsion_phase</span><span class="p">,</span> <span class="n">torsion_period</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;IMPR&#39;</span><span class="p">:</span>
            <span class="n">amber_card_type_7</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">improper_factor</span><span class="p">,</span>
                              <span class="n">improper_barrier</span><span class="p">,</span> <span class="n">improper_phase</span><span class="p">,</span> <span class="n">improper_period</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;HBON&#39;</span><span class="p">:</span>
            <span class="n">amber_card_type_8</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">other_parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;NONB&#39;</span><span class="p">:</span>
            <span class="n">amber_card_type_10B</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">other_parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CMAP&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Yeah, Im not bothering to implement cmap&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;END&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;parameters loaded&#39;</span><span class="p">)</span>
    <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">radians</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angle_equil</span><span class="p">:</span>
            <span class="n">angle_equil</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle_equil</span><span class="p">[</span><span class="n">angle</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">torsion_phase</span><span class="p">:</span>
            <span class="n">torsion_phase</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">torsion_phase</span><span class="p">[</span><span class="n">torsion</span><span class="p">]))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">amber_atoms</span><span class="p">,</span> <span class="n">atom_mass</span><span class="p">,</span> <span class="n">atom_polarizability</span><span class="p">,</span> <span class="n">bond_force</span><span class="p">,</span> <span class="n">bond_equil</span><span class="p">,</span>
            <span class="n">angle_force</span><span class="p">,</span> <span class="n">angle_equil</span><span class="p">,</span> <span class="n">torsion_factor</span><span class="p">,</span> <span class="n">torsion_barrier</span><span class="p">,</span> <span class="n">torsion_phase</span><span class="p">,</span>
            <span class="n">torsion_period</span><span class="p">,</span> <span class="n">improper_factor</span><span class="p">,</span> <span class="n">improper_barrier</span><span class="p">,</span> <span class="n">improper_phase</span><span class="p">,</span>
            <span class="n">improper_period</span><span class="p">,</span> <span class="n">other_parameters</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">amber_card_type_2</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">atom_mass</span><span class="p">,</span> <span class="n">atom_polarizability</span><span class="p">):</span>

    <span class="c1">#section 2 input for atom symbols and masses</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">==</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">mass</span><span class="p">,</span> <span class="n">polarizability</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">atom_mass</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span><span class="o">=</span><span class="n">mass</span>
            <span class="n">atom_polarizability</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span><span class="o">=</span><span class="n">polarizability</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># sometimes a polarizability is not listed</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">atom_mass</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span><span class="o">=</span><span class="n">mass</span>
            <span class="n">atom_polarizability</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span><span class="o">=</span><span class="n">polarizability</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Should be 2A, X, F10.2, F10.2, comments but got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">amber_card_type_3</span><span class="p">(</span><span class="n">f_in</span><span class="p">):</span>
    <span class="c1">#section 3  input for atom symbols that are hydrophilic</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f_in</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">amber_card_type_4</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">bond_force</span><span class="p">,</span> <span class="n">bond_equil</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">#section 4  bond length paramters</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">==</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">atom1</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span> <span class="n">strip</span><span class="p">()</span>
        <span class="n">atom2</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">bond</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">)))</span> <span class="c1"># put in alphabetical order</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bond</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">25</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Expected 2 floats but got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span>
        <span class="n">force_constant</span><span class="p">,</span> <span class="n">equil_length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">bond_force</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">=</span><span class="n">force_constant</span>
        <span class="n">bond_equil</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">=</span><span class="n">equil_length</span>
        <span class="c1">#this should throw an error if there are not </span>

<span class="k">def</span> <span class="nf">amber_card_type_5</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">angle_force</span><span class="p">,</span> <span class="n">angle_equil</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">#section 5</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">==</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">atom1</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">atom2</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">atom3</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">sorted13</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom3</span><span class="p">))</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="p">(</span><span class="n">sorted13</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">sorted13</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># I want it sorted alphabetically by 1-3 atoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">angle</span><span class="o">=</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">28</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Expected 2 floats but got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span>
        <span class="n">force_constant</span><span class="p">,</span> <span class="n">equil_angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">angle_force</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span><span class="o">=</span><span class="n">force_constant</span>
        <span class="n">angle_equil</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span><span class="o">=</span><span class="n">equil_angle</span>

<span class="k">def</span> <span class="nf">amber_card_type_6</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">torsion_factor</span><span class="p">,</span> <span class="n">torsion_barrier</span><span class="p">,</span> <span class="n">torsion_phase</span><span class="p">,</span>
                      <span class="n">torsion_period</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">#secti on 6 torsion / proper dihedral</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">==</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">atom1</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">atom2</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">atom3</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">atom4</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">sort23</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">atom2</span><span class="p">,</span> <span class="n">atom1</span><span class="p">),</span> <span class="p">(</span><span class="n">atom3</span><span class="p">,</span> <span class="n">atom4</span><span class="p">)],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">torsion</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="p">(</span><span class="n">sort23</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">torsion</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span><span class="p">,</span> <span class="n">atom4</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">55</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">!=</span><span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;I wanted four values here?&#39;</span><span class="p">)</span>
        <span class="c1">#the actual torsion potential is (barrier/factor)*(1+cos(period*phi-phase))</span>
        <span class="k">if</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">torsion_period</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torsion_period</span><span class="p">[</span><span class="n">torsion</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">torsion_factor</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="p">]</span>
                <span class="n">torsion_barrier</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="n">torsion_phase</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>   <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                <span class="n">torsion_period</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="n">torsion_period</span><span class="p">[</span><span class="n">torsion</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">torsion_factor</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="nb">int</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">torsion_barrier</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">torsion_phase</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">torsion_period</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">torsion_factor</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="p">]</span>
            <span class="n">torsion_barrier</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">torsion_phase</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>   <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
            <span class="n">torsion_period</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>

<span class="k">def</span> <span class="nf">amber_card_type_7</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">improper_factor</span><span class="p">,</span> <span class="n">improper_barrier</span><span class="p">,</span>
                      <span class="n">improper_phase</span><span class="p">,</span> <span class="n">improper_period</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">#section 7 improper dihedrals </span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">==</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">atom1</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">atom2</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">atom3</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">atom4</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">sort23</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">atom2</span><span class="p">,</span> <span class="n">atom1</span><span class="p">),</span> <span class="p">(</span><span class="n">atom3</span><span class="p">,</span> <span class="n">atom4</span><span class="p">)],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">torsion</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="p">(</span><span class="n">sort23</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">torsion</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span><span class="p">,</span> <span class="n">atom4</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">55</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">improper_barrier</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">improper_phase</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>   <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">improper_period</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;This seems allowed in the doc but doesnt appear in reality&#39;</span><span class="p">)</span>
            <span class="n">improper_factor</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">improper_barrier</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">improper_phase</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>   <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">improper_period</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="c1">#the actual torsion potential is (barrier/factor)*(1+cos(period*phi-phase))</span>
        <span class="c1">#it seems improper potential don&#39;t divide by the factor</span>

<span class="k">def</span> <span class="nf">amber_card_type_8</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">other_parameters</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">#section 8  H-bond 10-12 potential parameters</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">==</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">atom1</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">atom2</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">pair</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;H_bond_10_12_parameters&#39;</span><span class="p">][</span><span class="n">pair</span><span class="p">]</span><span class="o">=</span><span class="n">contents</span>

<span class="k">def</span> <span class="nf">amber_card_type_9</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">other_parameters</span><span class="p">):</span>
    <span class="c1">#section 9 equi valencing atom symbols for non-bonded 6-12 potential parameters</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">==</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;equivalences&#39;</span><span class="p">][</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">contents</span>

<span class="k">def</span> <span class="nf">amber_card_type_10B</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">other_parameters</span><span class="p">):</span>
    <span class="c1">#section 10 6-12  potential parameters</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;vdw_potential_well_depth&#39;</span><span class="p">][</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>

<span class="k">def</span> <span class="nf">get_convolutions</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">pdb_atom_names</span><span class="p">,</span>
                              <span class="n">atom_label</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">,</span><span class="s1">&#39;string&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                              <span class="n">perform_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">v</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                              <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">return_type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span><span class="s1">&#39;idxs&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                              <span class="n">absolute_torsion_period</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">NB</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;matrix&#39;</span><span class="p">,)[</span><span class="mi">0</span><span class="p">],</span>
                              <span class="n">fix_terminal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">fix_charmm_residues</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">fix_slice_method</span><span class="o">=</span><span class="kc">False</span>
                             <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ##INPUTS##</span>

<span class="sd">    dataset:         one frame of a trajectory of shape [3, N]</span>

<span class="sd">    pdb_atom_names:  should be an array of shape [N,2]</span>
<span class="sd">                     pdb_atom_names[:,0] is the pdb_atom_names and</span>
<span class="sd">                     pdb_atom_names[:,1] is the residue names</span>

<span class="sd">    atom_label:      (default, &#39;set&#39;) deprecated and broken for anything other than &#39;set&#39;</span>

<span class="sd">    perform_checks:  No longer works so has been removed</span>

<span class="sd">    v:               (default, 2) atom_selection version, bonds are determined by interatomic</span>
<span class="sd">                     distance, with v=2. v=1 shouldn&#39;t be used except in specific cirumstances</span>

<span class="sd">    order:           (bool, default false) are atoms ordered, I think I&#39;ve fixed this so that</span>
<span class="sd">                     it shouldn&#39;t matter either way but keep as False.</span>

<span class="sd">    return_type:     (option now removed)</span>


<span class="sd">    ##OUTPUTS##</span>
<span class="sd">    convolution output shape N* will be N-(conv length -1)+padding</span>

<span class="sd">    bond_masks, b_equil, b_force: shape [number of convolutions, N*]</span>

<span class="sd">    bond_weights: shape[number of convolutions, conv_size]</span>

<span class="sd">    angle_masks, a_equil, a_force:  shape [number of convolutions,  conv_size]</span>

<span class="sd">    angle_weights: shape[number of convolutions, 2, conv_size]</span>

<span class="sd">    torsion_masks: shape[number of convolution, 3, conv_size]</span>

<span class="sd">    t_para:        shape[num of convs, N*, 4, max number torsion parameters ]</span>

<span class="sd">    tornsion_weigths: shape [number of convolutions, 3, conv_size]</span>




<span class="sd">    examples code:</span>
<span class="sd">        dataset, meanval, stdval, atom_info, charge_vdw=load_data(file_name, get_atom_info=&#39;idxs&#39;)</span>
<span class="sd">        a = get_convolutions((dataset*stdval)[0], atom_info)</span>


<span class="sd">    &#39;&#39;&#39;</span>


    <span class="c1">#get amber parameters</span>
    <span class="p">(</span><span class="n">amber_atoms</span><span class="p">,</span> <span class="n">atom_mass</span><span class="p">,</span> <span class="n">atom_polarizability</span><span class="p">,</span> <span class="n">bond_force</span><span class="p">,</span> <span class="n">bond_equil</span><span class="p">,</span>
    <span class="n">angle_force</span><span class="p">,</span> <span class="n">angle_equil</span><span class="p">,</span> <span class="n">torsion_factor</span><span class="p">,</span> <span class="n">torsion_barrier</span><span class="p">,</span> <span class="n">torsion_phase</span><span class="p">,</span>
    <span class="n">torsion_period</span><span class="p">,</span> <span class="n">improper_factor</span><span class="p">,</span> <span class="n">improper_barrier</span><span class="p">,</span> <span class="n">improper_phase</span><span class="p">,</span>
    <span class="n">improper_period</span><span class="p">,</span> <span class="n">other_parameters</span><span class="p">)</span> <span class="o">=</span>  <span class="n">get_amber_parameters</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">fix_terminal</span><span class="p">:</span>
        <span class="n">pdb_atom_names</span><span class="p">[</span><span class="n">pdb_atom_names</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;OXT&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;O&#39;</span>
    <span class="k">if</span> <span class="n">fix_charmm_residues</span><span class="p">:</span>
        <span class="n">pdb_atom_names</span><span class="p">[</span><span class="n">pdb_atom_names</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;HSD&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;HID&#39;</span>
        <span class="n">pdb_atom_names</span><span class="p">[</span><span class="n">pdb_atom_names</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;HSE&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;HIE&#39;</span>

    <span class="n">atom_names</span> <span class="o">=</span> <span class="p">[[</span><span class="n">amber_atoms</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="n">atom</span><span class="p">],</span><span class="n">res</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">pdb_atom_names</span> <span class="p">]</span>
    <span class="n">atom_charges</span><span class="o">=</span><span class="p">[</span><span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">][</span><span class="n">res</span><span class="p">][</span><span class="n">atom</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">atom_names</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determining bonds&#39;</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">v</span> <span class="c1"># method of selecting bonded atoms</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#2145</span>

    <span class="n">cmat</span><span class="o">=</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pdist</span><span class="p">((</span><span class="n">dataset</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">bond_idxs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">cmat</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
        <span class="c1">#this will work for any non cyclic monomeric protein</span>
        <span class="c1">#that in mind will break if enough proline atoms to make a cycle are selected</span>
        <span class="n">bond_idxs</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">bond_idxs</span><span class="p">[:</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bond_idxs</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cmat</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">-</span><span class="n">cmat</span><span class="p">[</span><span class="n">bond_idxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">&lt;</span><span class="mf">0.25</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;WARNING: May not have correctly selected the bonded distances: value &quot;</span>
                            <span class="o">+</span><span class="p">(</span><span class="n">cmat</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">-</span><span class="n">cmat</span><span class="p">[</span><span class="n">bond_idxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">+</span>
                            <span class="s2">&quot;should be roughly between 0.42 and 0.57 (&gt;0.25)&quot;</span> <span class="p">)</span><span class="c1"># should be 0.42-0.57</span>
            <span class="n">version</span><span class="o">+=</span><span class="mi">1</span> <span class="c1">#try version 2 instead</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">cmat</span><span class="p">[</span><span class="n">bond_idxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">((</span><span class="n">cmat</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">-</span><span class="n">cmat</span><span class="p">[</span><span class="n">bond_idxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#mid point </span>
        <span class="n">full_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmat</span><span class="o">&lt;</span><span class="n">mid</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int8&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">full_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmat</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">1.643</span><span class="o">+</span><span class="mf">2.129</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int8&#39;</span><span class="p">)</span> 
        <span class="n">bond_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">full_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># for some reason returns tuple with one array</span>
    <span class="n">all_bond_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">bond_idxs</span><span class="p">)</span>

    <span class="n">bond_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bond_idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tracker</span> <span class="o">=</span> <span class="p">[[]]</span> <span class="c1"># this will keep track of some of the bonds to help work out the angles</span>
    <span class="n">atom1</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">atom2</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#index of the distance N,N+1</span>
    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">all_bond_idxs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bond</span> <span class="o">&lt;</span> <span class="n">counter</span><span class="o">+</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">atom1</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="n">atom1</span><span class="o">+</span><span class="n">bond</span><span class="o">-</span><span class="n">counter</span><span class="o">+</span><span class="mi">1</span> <span class="c1"># 0-0+1</span>
            <span class="n">tracker</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom2</span><span class="p">)</span> <span class="c1">#</span>
        <span class="k">while</span> <span class="n">bond</span> <span class="o">&gt;</span> <span class="n">counter</span><span class="o">+</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">atom1</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">counter</span><span class="o">+=</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">atom1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atom1</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="n">tracker</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">if</span> <span class="n">bond</span> <span class="o">&lt;</span> <span class="n">counter</span><span class="o">+</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">atom1</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">atom2</span> <span class="o">=</span> <span class="n">atom1</span><span class="o">+</span><span class="n">bond</span><span class="o">-</span><span class="n">counter</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">tracker</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">atom_label</span><span class="o">==</span><span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="c1">#string of atom labels, doesn&#39;t handle Proline alternate ordering</span>
            <span class="n">bond_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom_names</span><span class="p">[</span><span class="n">atom1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">atom_names</span><span class="p">[</span><span class="n">atom2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bond_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">atom_label</span><span class="o">==</span><span class="s1">&#39;set&#39;</span><span class="p">:</span> <span class="c1">#set of atom labels</span>
            <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">atom_names</span><span class="p">[</span><span class="n">atom1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom2</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom_names</span><span class="p">[</span><span class="n">atom1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bond_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="n">bond_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">])</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span><span class="o">&lt;</span><span class="n">N</span><span class="p">:</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span> <span class="c1">#ensure so the next bit doesn&#39;t break by indexing N-1</span>

    <span class="c1">##################### Angles/1-3 #####################</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determining angles&#39;</span><span class="p">)</span>
    <span class="n">angle_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">angle_idxs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">torsion_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">torsion_idxs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">bond_14_idxs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">counter</span><span class="o">=</span><span class="mi">0</span>
    <span class="c1">#add missing bonds (each bond counted twice after but atom3&gt;atom1 prevents duplicates later )</span>
    <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom1_bonds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">tracker</span><span class="p">)):</span> <span class="c1"># for _, [] in enum [[]]</span>
        <span class="k">for</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">atom1_bonds</span><span class="p">:</span>                           <span class="c1"># for _ in []</span>
            <span class="n">tracker</span><span class="p">[</span><span class="n">atom2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom1</span><span class="p">)</span>
    <span class="c1"># find every angle and add it</span>
    <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom1_bonds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tracker</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">atom1_bonds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom3</span> <span class="ow">in</span> <span class="n">tracker</span><span class="p">[</span><span class="n">atom2</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">atom3</span><span class="o">&gt;</span><span class="n">atom1</span><span class="p">:</span> <span class="c1">#each angle will only be counter once</span>
                    <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
                        <span class="n">sort13</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span> <span class="p">(</span><span class="n">atom_names</span><span class="p">[</span><span class="n">atom1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom1</span><span class="p">),</span> <span class="p">(</span><span class="n">atom_names</span><span class="p">[</span><span class="n">atom3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom3</span><span class="p">)</span> <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="p">(</span><span class="n">sort13</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sort13</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>

                        <span class="n">angle_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                        <span class="n">angle_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sort13</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">sort13</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">angle_types</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom_names</span><span class="p">[</span><span class="n">atom1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">atom_names</span><span class="p">[</span><span class="n">atom3</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">angle_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">atom3</span> <span class="o">!=</span> <span class="n">atom1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">atom4</span> <span class="ow">in</span> <span class="n">tracker</span><span class="p">[</span><span class="n">atom3</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">atom4</span><span class="o">&gt;</span><span class="n">atom1</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">!=</span><span class="n">atom4</span><span class="p">:</span><span class="c1"># each torsion will be counter once</span>
                            <span class="c1">#torsions are done based on the 2 3 atoms, so sort 23</span>
                            <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
                                <span class="n">sort23</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span> <span class="p">(</span><span class="n">atom_names</span><span class="p">[</span><span class="n">atom2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom1</span><span class="p">),</span>
                                                  <span class="p">(</span><span class="n">atom_names</span><span class="p">[</span><span class="n">atom3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom3</span><span class="p">,</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom4</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom4</span><span class="p">)</span> <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="p">(</span><span class="n">sort23</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="p">)</span>
                                <span class="n">torsion_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                                <span class="n">torsion_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sort23</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">sort23</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">torsion_types</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom_names</span><span class="p">[</span><span class="n">atom1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">atom_names</span><span class="p">[</span><span class="n">atom3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom4</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                                <span class="n">torsion_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span><span class="p">,</span> <span class="n">atom4</span><span class="p">])</span>
                            <span class="n">bond_14_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom1</span><span class="p">,</span><span class="n">atom4</span><span class="p">])</span>
    <span class="c1">#currently have bond_types, angle_types, and torsion_typs + idxs</span>
    <span class="n">bond_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bond_idxs</span><span class="p">)</span>
    <span class="n">angle_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angle_idxs</span><span class="p">)</span>
    <span class="n">torsion_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">)</span>
    <span class="n">bond_max_conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">bond_idxs</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">bond_idxs</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">bond_max_conv</span><span class="o">&lt;</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">fix_slice_method</span><span class="p">:</span>
        <span class="n">bond_max_conv</span><span class="o">=</span><span class="mi">3</span>
    <span class="n">angle_max_conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle_idxs</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">angle_idxs</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">angle_max_conv</span><span class="o">&lt;</span><span class="mi">5</span> <span class="ow">and</span> <span class="n">fix_slice_method</span><span class="p">:</span>
        <span class="n">angle_max_conv</span><span class="o">=</span><span class="mi">5</span>
    <span class="n">torsion_max_conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">torsion_idxs</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">torsion_idxs</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">torsion_max_conv</span><span class="o">&lt;</span><span class="mi">7</span> <span class="ow">and</span> <span class="n">fix_slice_method</span><span class="p">:</span>
        <span class="n">torsion_max_conv</span><span class="o">=</span><span class="mi">7</span>
        <span class="c1">#there is a problem where i accidentally index [padding-3] so if (len -4) &lt; 3 we index -1 which breaks things</span>
        <span class="c1">#it shouldn&#39;t affect anything to say the max conv is greater than 6</span>
    <span class="c1">#this little bit just turns the &#39;types&#39; list into equivalent parameters</span>
    <span class="c1">#key error if you don&#39;t have the parameter</span>
    <span class="n">bond_para</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="n">bond_equil</span><span class="p">[</span><span class="n">bond</span><span class="p">],</span> <span class="n">bond_force</span><span class="p">[</span><span class="n">bond</span><span class="p">]]</span> <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bond_equil</span>
              <span class="k">else</span> <span class="p">[</span><span class="n">bond_equil</span><span class="p">[(</span><span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">bond_force</span><span class="p">[(</span><span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">])]]</span>
              <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bond_types</span><span class="p">])</span>
    <span class="n">angle_para</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="n">angle_equil</span><span class="p">[</span><span class="n">angle</span><span class="p">],</span> <span class="n">angle_force</span><span class="p">[</span><span class="n">angle</span><span class="p">]]</span> <span class="k">if</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angle_equil</span>
              <span class="k">else</span> <span class="p">[</span><span class="n">angle_equil</span><span class="p">[(</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">angle_force</span><span class="p">[(</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">])]]</span>
              <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angle_types</span><span class="p">])</span>
    <span class="n">torsion_para</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">t_unique</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">torsion_types</span><span class="p">))</span>
    <span class="n">t_unique_para</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">max_para</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">t_unique</span><span class="p">:</span>
        <span class="n">torsion_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">torsion_xx</span>  <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="n">torsion_xb</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">torsion_barrier</span><span class="p">:</span>
            <span class="n">max_para</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_para</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">torsion_barrier</span><span class="p">[</span><span class="n">torsion</span><span class="p">]))</span>
            <span class="n">t_unique_para</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="n">torsion_factor</span><span class="p">[</span><span class="n">torsion</span><span class="p">],</span> <span class="n">torsion_barrier</span><span class="p">[</span><span class="n">torsion</span><span class="p">],</span>
                                     <span class="n">torsion_phase</span><span class="p">[</span><span class="n">torsion</span><span class="p">],</span>  <span class="n">torsion_period</span><span class="p">[</span><span class="n">torsion</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">torsion_b</span> <span class="ow">in</span> <span class="n">torsion_barrier</span><span class="p">:</span>
            <span class="n">max_para</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_para</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">torsion_barrier</span><span class="p">[</span><span class="n">torsion_b</span><span class="p">]))</span>
            <span class="n">t_unique_para</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="n">torsion_factor</span><span class="p">[</span><span class="n">torsion_b</span><span class="p">],</span> <span class="n">torsion_barrier</span><span class="p">[</span><span class="n">torsion_b</span><span class="p">],</span>
                                     <span class="n">torsion_phase</span><span class="p">[</span><span class="n">torsion_b</span><span class="p">],</span>  <span class="n">torsion_period</span><span class="p">[</span><span class="n">torsion_b</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">torsion_xx</span> <span class="ow">in</span> <span class="n">torsion_barrier</span><span class="p">:</span>
            <span class="n">max_para</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_para</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">torsion_barrier</span><span class="p">[</span><span class="n">torsion_xx</span><span class="p">]))</span>
            <span class="n">t_unique_para</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="n">torsion_factor</span><span class="p">[</span><span class="n">torsion_xx</span><span class="p">],</span> <span class="n">torsion_barrier</span><span class="p">[</span><span class="n">torsion_xx</span><span class="p">],</span>
                                     <span class="n">torsion_phase</span><span class="p">[</span><span class="n">torsion_xx</span><span class="p">],</span>  <span class="n">torsion_period</span><span class="p">[</span><span class="n">torsion_xx</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">torsion_xb</span> <span class="ow">in</span> <span class="n">torsion_barrier</span><span class="p">:</span>
            <span class="n">max_para</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_para</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">torsion_barrier</span><span class="p">[</span><span class="n">torsion_xb</span><span class="p">]))</span>
            <span class="n">t_unique_para</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="n">torsion_factor</span><span class="p">[</span><span class="n">torsion_xb</span><span class="p">],</span> <span class="n">torsion_barrier</span><span class="p">[</span><span class="n">torsion_xb</span><span class="p">],</span>
                                     <span class="n">torsion_phase</span><span class="p">[</span><span class="n">torsion_xb</span><span class="p">],</span>  <span class="n">torsion_period</span><span class="p">[</span><span class="n">torsion_xb</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Torsion </span><span class="si">%s</span><span class="s1"> cannot be found in torsion_barrier and will not be included&#39;</span><span class="o">%</span> <span class="n">torsion</span><span class="p">)</span>
    <span class="n">torsion_para</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">torsion_types</span><span class="p">),</span><span class="mi">4</span><span class="p">,</span><span class="n">max_para</span><span class="p">))</span>
    <span class="c1">#we don&#39;t want barrier/factor to return nan so set factor to 1 by default</span>
    <span class="n">torsion_para</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">torsion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">torsion_types</span><span class="p">):</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">t_unique_para</span><span class="p">[</span><span class="n">torsion</span><span class="p">]</span>
        <span class="n">torsion_para</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:</span><span class="nb">len</span><span class="p">(</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">=</span><span class="n">para</span>
    <span class="c1">##### make phase positive #####</span>
    <span class="k">if</span> <span class="n">absolute_torsion_period</span><span class="p">:</span>
        <span class="n">torsion_para</span><span class="p">[:,</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torsion_para</span><span class="p">[:,</span><span class="mi">3</span><span class="p">,:])</span>



    <span class="c1">###############################  bonds  #################################</span>

    <span class="n">bond_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">bond_max_conv</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="p">(</span><span class="n">bond_max_conv</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bond_max_conv</span><span class="o">-</span><span class="mi">2</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="n">bond_conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">bond_idxs</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">bond_idxs</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>

    <span class="n">bond_weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b_equil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bond_masks</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">b_force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bond_masks</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bond_max_conv</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">bond_max_conv</span>
        <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=-</span><span class="mf">1.0</span>
        <span class="n">bond_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">mask_index</span><span class="o">=</span><span class="n">bond_idxs</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">bond_conv</span><span class="o">==</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">bond_max_conv</span><span class="o">-</span><span class="mi">2</span>
        <span class="n">bond_masks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">mask_index</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">b_equil</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">mask_index</span><span class="p">]</span><span class="o">=</span><span class="n">bond_para</span><span class="p">[</span><span class="n">bond_conv</span><span class="o">==</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">b_force</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">mask_index</span><span class="p">]</span>     <span class="o">=</span><span class="n">bond_para</span><span class="p">[</span><span class="n">bond_conv</span><span class="o">==</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">###############################  angles  #################################</span>

    <span class="n">angle_conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle_idxs</span><span class="o">-</span><span class="n">angle_idxs</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="c1">#relative positions of atoms</span>
    <span class="n">angle_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">angle_conv</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">angle_conv</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">angle_conv</span><span class="p">,</span><span class="n">angle_conv</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span> <span class="c1">#remove mirrors</span>
    <span class="n">angle_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">angle_conv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#unique</span>

    <span class="n">angle_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_unique</span><span class="p">),</span> <span class="n">N</span><span class="o">-</span><span class="p">(</span><span class="n">angle_max_conv</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">angle_max_conv</span><span class="o">-</span><span class="mi">3</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="n">angle_weights</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">a_equil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">angle_masks</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">a_force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">angle_masks</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">angle_unique</span><span class="p">):</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">angle_max_conv</span><span class="p">,[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">angle_max_conv</span><span class="p">]</span> <span class="c1"># 2xsize</span>
        <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=-</span><span class="mf">1.0</span>
        <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=-</span><span class="mf">1.0</span>
        <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">angle_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">mask_index</span> <span class="o">=</span> <span class="n">angle_idxs</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[(</span><span class="n">angle_conv</span><span class="o">==</span><span class="n">angle</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="n">angle_max_conv</span><span class="o">-</span><span class="mi">3</span>
        <span class="n">a_equil</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">mask_index</span><span class="p">]</span><span class="o">=</span><span class="n">angle_para</span><span class="p">[(</span><span class="n">angle_conv</span><span class="o">==</span><span class="n">angle</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a_force</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">mask_index</span><span class="p">]</span>     <span class="o">=</span><span class="n">angle_para</span><span class="p">[(</span><span class="n">angle_conv</span><span class="o">==</span><span class="n">angle</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">angle_masks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">mask_index</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>


    <span class="c1">###############################  torsion  #################################</span>

    <span class="n">torsion_conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">torsion_idxs</span><span class="o">-</span><span class="n">torsion_idxs</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="c1">#relative positions of atoms</span>
    <span class="n">torsion_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">torsion_conv</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">torsion_conv</span><span class="p">[:,</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">torsion_conv</span><span class="p">,</span><span class="n">torsion_conv</span><span class="p">[:,[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span> <span class="c1">#remove mirrors</span>
    <span class="n">torsion_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">torsion_conv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#unique</span>

    <span class="n">torsion_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">torsion_unique</span><span class="p">),</span> <span class="n">N</span><span class="o">-</span><span class="p">(</span><span class="n">torsion_max_conv</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">torsion_max_conv</span><span class="o">-</span><span class="mi">4</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="n">torsion_weights</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">torsion_masks</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">t_para</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">torsion_masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">torsion_masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">torsion_para</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion_para</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="c1">#we don&#39;t want barrier/factor to return nan so set factor to 1 by default</span>
    <span class="n">t_para</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">torsion_unique</span><span class="p">):</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">torsion_max_conv</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">torsion_max_conv</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">torsion_max_conv</span><span class="p">]</span>
        <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span>  <span class="mf">1.0</span> <span class="c1">#b1 = ri-rj</span>
        <span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span>  <span class="mf">1.0</span> <span class="c1">#b2 = rj-rk</span>
        <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">weight</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1">#b3 = rl-rk</span>
        <span class="n">weight</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span>  <span class="mf">1.0</span>
        <span class="n">torsion_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">mask_index</span> <span class="o">=</span> <span class="n">torsion_idxs</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[(</span><span class="n">torsion_conv</span><span class="o">==</span><span class="n">torsion</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="n">torsion_max_conv</span><span class="o">-</span><span class="mi">4</span>
        <span class="n">torsion_masks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">mask_index</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">t_para</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">mask_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">torsion_para</span><span class="p">[(</span><span class="n">torsion_conv</span><span class="o">==</span><span class="n">torsion</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">NB</span><span class="o">==</span><span class="s1">&#39;matrix&#39;</span><span class="p">:</span>
        <span class="n">equiv_t</span><span class="o">=</span><span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;equivalences&#39;</span><span class="p">]</span>
        <span class="n">vdw_para</span> <span class="o">=</span> <span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;vdw_potential_well_depth&#39;</span><span class="p">]</span>
        <span class="c1">#switch these around so that values point to key</span>
        <span class="n">equiv</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">equiv_t</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">equiv_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">equiv</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">i</span>
        <span class="n">atom_R</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">vdw_para</span><span class="p">[</span><span class="n">equiv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">atom_names</span><span class="p">])</span> <span class="c1">#radius</span>
        <span class="n">atom_e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">vdw_para</span><span class="p">[</span><span class="n">equiv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">atom_names</span><span class="p">])</span> <span class="c1">#welldepth</span>
        <span class="c1">#cdist is easier to work with than pdist, batch pdist was removed from torch and has not been readded as of writting this</span>
        <span class="n">vdw_R</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">atom_R</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">atom_R</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vdw_e</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom_e</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">atom_e</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="c1">#set 1-2, and 1-3 distances to 0.0</span>
        <span class="n">vdw_R</span><span class="p">[</span><span class="n">bond_idxs</span><span class="o">.</span><span class="n">T</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">vdw_e</span><span class="p">[</span><span class="n">bond_idxs</span><span class="o">.</span><span class="n">T</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">vdw_R</span><span class="p">[</span><span class="n">angle_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">vdw_e</span><span class="p">[</span><span class="n">angle_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">vdw_R</span><span class="p">[</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">vdw_e</span><span class="p">[</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>

        <span class="n">e_</span><span class="o">=</span><span class="mf">1.0</span> <span class="c1">#permitivity </span>
        <span class="n">atom_charges</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">atom_charges</span><span class="p">)</span>
        <span class="n">q1q2</span><span class="o">=</span><span class="p">(</span><span class="n">atom_charges</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">atom_charges</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">e_</span><span class="p">)</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#Aij=bi*bj</span>
        <span class="n">q1q2</span><span class="p">[</span><span class="n">bond_idxs</span><span class="o">.</span><span class="n">T</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">q1q2</span><span class="p">[</span><span class="n">angle_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">q1q2</span><span class="p">[</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>

        <span class="c1">#1-4 are should be included but scaled</span>
        <span class="n">bond_14_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bond_14_idxs</span><span class="p">)</span>
        <span class="n">vdw_14R</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">atom_R</span><span class="p">[</span><span class="n">bond_14_idxs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">atom_R</span><span class="p">[</span><span class="n">bond_14_idxs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">vdw_14e</span><span class="o">=</span><span class="p">(</span><span class="n">atom_e</span><span class="p">[</span><span class="n">bond_14_idxs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">atom_e</span><span class="p">[</span><span class="n">bond_14_idxs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">q1q2_14</span><span class="o">=</span><span class="p">(</span><span class="n">atom_charges</span><span class="p">[</span><span class="n">bond_14_idxs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">atom_charges</span><span class="p">[</span><span class="n">bond_14_idxs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])</span><span class="o">/</span><span class="n">e_</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">bond_masks</span><span class="p">,</span>  <span class="n">b_equil</span><span class="p">,</span> <span class="n">b_force</span><span class="p">,</span> <span class="n">bond_weights</span><span class="p">,</span>
                <span class="n">angle_masks</span><span class="p">,</span> <span class="n">a_equil</span><span class="p">,</span> <span class="n">a_force</span><span class="p">,</span> <span class="n">angle_weights</span><span class="p">,</span>
                <span class="n">torsion_masks</span><span class="p">,</span> <span class="n">t_para</span><span class="p">,</span> <span class="n">torsion_weights</span><span class="p">,</span>
                <span class="n">vdw_R</span><span class="p">,</span> <span class="n">vdw_e</span><span class="p">,</span> <span class="n">vdw_14R</span><span class="p">,</span> <span class="n">vdw_14e</span><span class="p">,</span>
                <span class="n">q1q2</span><span class="p">,</span> <span class="n">q1q2_14</span>
               <span class="p">)</span>



    <span class="k">return</span> <span class="p">(</span><span class="n">bond_masks</span><span class="p">,</span>  <span class="n">b_equil</span><span class="p">,</span> <span class="n">b_force</span><span class="p">,</span> <span class="n">bond_weights</span><span class="p">,</span>
            <span class="n">angle_masks</span><span class="p">,</span> <span class="n">a_equil</span><span class="p">,</span> <span class="n">a_force</span><span class="p">,</span> <span class="n">angle_weights</span><span class="p">,</span>
            <span class="n">torsion_masks</span><span class="p">,</span> <span class="n">t_para</span><span class="p">,</span> <span class="n">torsion_weights</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_conv_pad_res</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">pdb_atom_names</span><span class="p">,</span>
                              <span class="n">absolute_torsion_period</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">NB</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;matrix&#39;</span><span class="p">,)[</span><span class="mi">0</span><span class="p">],</span>
                              <span class="n">fix_terminal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">fix_charmm_residues</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">correct_1_4</span><span class="o">=</span><span class="kc">True</span>
                             <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ##INPUTS##</span>

<span class="sd">    dataset:         one frame of a trajectory of shape [3, N]</span>

<span class="sd">    pdb_atom_names:  should be an array of shape [N,2]</span>
<span class="sd">                     pdb_atom_names[:,0] is the pdb_atom_names and</span>
<span class="sd">                     pdb_atom_names[:,1] is the residue names</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;967 dataset frame here should be of shape [R, M, 3] not </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">pdb_atom_names</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;969 dataset.shape != pdb_atom_names.shape&#39;</span><span class="p">)</span>


    <span class="c1">#get amber parameters</span>
    <span class="p">(</span><span class="n">amber_atoms</span><span class="p">,</span> <span class="n">atom_mass</span><span class="p">,</span> <span class="n">atom_polarizability</span><span class="p">,</span> <span class="n">bond_force</span><span class="p">,</span> <span class="n">bond_equil</span><span class="p">,</span>
    <span class="n">angle_force</span><span class="p">,</span> <span class="n">angle_equil</span><span class="p">,</span> <span class="n">torsion_factor</span><span class="p">,</span> <span class="n">torsion_barrier</span><span class="p">,</span> <span class="n">torsion_phase</span><span class="p">,</span>
    <span class="n">torsion_period</span><span class="p">,</span> <span class="n">improper_factor</span><span class="p">,</span> <span class="n">improper_barrier</span><span class="p">,</span> <span class="n">improper_phase</span><span class="p">,</span>
    <span class="n">improper_period</span><span class="p">,</span> <span class="n">other_parameters</span><span class="p">)</span> <span class="o">=</span>  <span class="n">get_amber_parameters</span><span class="p">()</span>


    <span class="n">R</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># N residues, Max atom per res, dimension D</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">R</span><span class="o">*</span><span class="n">M</span>
    <span class="c1"># [R*M, 3], 3 = atom, res, resid</span>
    <span class="n">pdb_atom_names</span> <span class="o">=</span> <span class="n">pdb_atom_names</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1"># [R*M, 3], 3 = x, y, z</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fix_terminal</span><span class="p">:</span><span class="c1">#fix atoms and residues not in amber parameters</span>
        <span class="n">pdb_atom_names</span><span class="p">[</span><span class="n">pdb_atom_names</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;OXT&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;O&#39;</span>
    <span class="k">if</span> <span class="n">fix_charmm_residues</span><span class="p">:</span>
        <span class="n">pdb_atom_names</span><span class="p">[</span><span class="n">pdb_atom_names</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;HSD&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;HID&#39;</span>
        <span class="n">pdb_atom_names</span><span class="p">[</span><span class="n">pdb_atom_names</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;HSE&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;HIE&#39;</span>

    <span class="c1">#pdb atoms -&gt; amber atom names and residues</span>
    <span class="n">padded_atom_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">amber_atoms</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="n">atom</span><span class="p">],</span><span class="n">res</span><span class="p">,</span> <span class="n">resid</span><span class="p">]</span> <span class="k">if</span> <span class="n">atom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">atom</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">resid</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">resid</span> <span class="ow">in</span> <span class="n">pdb_atom_names</span><span class="p">])</span>
    <span class="n">unpadded_atom_names</span> <span class="o">=</span> <span class="p">[[</span><span class="n">amber_atoms</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="n">atom</span><span class="p">],</span><span class="n">res</span><span class="p">,</span> <span class="n">resid</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">resid</span> <span class="ow">in</span> <span class="n">pdb_atom_names</span> <span class="k">if</span> <span class="n">atom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">padded_atom_charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">][</span><span class="n">res</span><span class="p">][</span><span class="n">atom</span><span class="p">]</span> <span class="k">if</span> <span class="n">atom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">padded_atom_names</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">padded_atom_names</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span> <span class="c1"># just a little check</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;996 padded_atom_names!=dataset.shape&#39;</span><span class="p">)</span>
    <span class="n">atom_names</span> <span class="o">=</span> <span class="n">padded_atom_names</span>
    <span class="n">atom_charges</span> <span class="o">=</span> <span class="n">padded_atom_charges</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determining bonds&#39;</span><span class="p">)</span>

    <span class="n">cmat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span> <span class="c1">#[R*M,3 ]-&gt; [R*M, R*M]</span>
    <span class="c1">#1.643 was max bond distance in MurD test, 2.129 was the smallest nonbonded distance</span>
    <span class="c1">#can&#39;t say what the best solution is but somewhere in the middle will probably be okay</span>
    <span class="n">all_bond_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmat</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">1.643</span><span class="o">+</span><span class="mf">2.1269</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># [R*M,R*M]</span>
    <span class="n">bond_idxs</span> <span class="o">=</span> <span class="n">all_bond_mask</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span> <span class="c1"># [B x 2] </span>
    <span class="c1">#name_set = set(atom_names[:,0])</span>

    <span class="n">connectivity</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span> <span class="c1"># this will keep track of some of the bonds to help work out the angles</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">bond_idxs</span><span class="p">:</span>
        <span class="n">connectivity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">connectivity</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c1">##################### Angles/1-3 #####################</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determining angles&#39;</span><span class="p">)</span>

    <span class="n">bond_idxs_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">angle_idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">torsion_idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bond_14_idxs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">bond_para</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">angle_para</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">torsion_para_</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">connectivity</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">atom2_list</span><span class="p">:</span>
            <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">atom1</span> <span class="o">&lt;</span> <span class="n">atom2</span><span class="p">:</span> <span class="c1">#stops any pair of atoms being selected twice</span>
                <span class="n">bond_idxs_</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">),</span> <span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="n">a1</span><span class="p">)]:</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bond_equil</span><span class="p">:</span>
                        <span class="n">bond_para</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">bond_equil</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">bond_force</span><span class="p">[</span><span class="n">b</span><span class="p">]])</span>
                        <span class="k">break</span> <span class="c1"># break prevents any bond from beind added twice</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No associated bond parameter&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">atom3</span> <span class="ow">in</span> <span class="n">connectivity</span><span class="p">[</span><span class="n">atom2</span><span class="p">]:</span>
                <span class="n">a3</span> <span class="o">=</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">atom3</span> <span class="o">&gt;</span> <span class="n">atom1</span><span class="p">:</span> <span class="c1">#each angle will only be counter once </span>
                    <span class="n">angle_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom1</span><span class="p">,</span><span class="n">atom2</span><span class="p">,</span><span class="n">atom3</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">),</span> <span class="p">(</span><span class="n">a3</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a1</span><span class="p">)]:</span>
                        <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angle_equil</span><span class="p">:</span>
                            <span class="n">angle_para</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">angle_equil</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">angle_force</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No associated angle parameter&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">atom3</span> <span class="o">!=</span> <span class="n">atom1</span><span class="p">:</span> <span class="c1">#don&#39;t go back to same atom</span>
                    <span class="k">for</span> <span class="n">atom4</span> <span class="ow">in</span> <span class="n">connectivity</span><span class="p">[</span><span class="n">atom3</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">atom4</span> <span class="o">&gt;</span> <span class="n">atom1</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">!=</span><span class="n">atom4</span><span class="p">:</span>
                            <span class="n">torsion_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span><span class="p">,</span> <span class="n">atom4</span><span class="p">])</span>
                            <span class="n">bond_14_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom4</span><span class="p">])</span>
                            <span class="n">a4</span> <span class="o">=</span> <span class="n">atom_names</span><span class="p">[</span><span class="n">atom4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">,</span><span class="n">a4</span><span class="p">),(</span><span class="n">a4</span><span class="p">,</span><span class="n">a3</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a1</span><span class="p">),(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">),(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">a3</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">)]:</span>
                                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">torsion_barrier</span><span class="p">:</span>
                                    <span class="n">torsion_para_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span>
                                            <span class="n">torsion_factor</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                                            <span class="n">torsion_barrier</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                                            <span class="n">torsion_phase</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                                            <span class="n">torsion_period</span><span class="p">[</span><span class="n">t</span><span class="p">]]))</span>
                                    <span class="k">break</span> <span class="c1">#each torsion only counter once</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No associated torsion parameter&#39;</span><span class="p">)</span>

    <span class="n">bond_idxs_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">bond_idxs_</span><span class="p">)</span>
    <span class="n">angle_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">angle_idxs</span><span class="p">)</span>
    <span class="n">torsion_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">)</span>
    <span class="n">bond_14_idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">bond_14_idxs</span><span class="p">)</span>
    <span class="n">bond_para</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">bond_para</span><span class="p">)</span>
    <span class="n">angle_para</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">angle_para</span><span class="p">)</span>
    <span class="n">max_number_torsion_para</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">torsion_para_</span><span class="p">])</span>
    <span class="n">torsion_para</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">4</span><span class="p">,</span><span class="n">max_number_torsion_para</span><span class="p">)</span>
    <span class="n">torsion_para</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">tf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">torsion_para_</span><span class="p">):</span>
        <span class="n">torsion_para</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="mi">0</span><span class="p">:</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">tf</span>
    <span class="k">if</span> <span class="n">absolute_torsion_period</span><span class="p">:</span>
        <span class="n">torsion_para</span><span class="p">[:,</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torsion_para</span><span class="p">[:,</span><span class="mi">3</span><span class="p">,:])</span>
    <span class="c1">###### Gather based potential ######</span>
    <span class="c1">#currently for data [B, R*M, 3] or [B, 3, N]</span>
    <span class="n">aij0</span> <span class="o">=</span> <span class="n">bond_idxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">angle_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">aij1</span> <span class="o">=</span> <span class="n">bond_idxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">angle_idxs</span><span class="p">[:,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ajk0</span> <span class="o">=</span> <span class="n">bond_idxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">angle_idxs</span><span class="p">[:,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ajk1</span> <span class="o">=</span> <span class="n">bond_idxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">angle_idxs</span><span class="p">[:,(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ij_jk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">aij0</span><span class="o">+</span><span class="n">aij1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">ajk0</span><span class="o">+</span><span class="n">ajk1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">aij_</span> <span class="o">=</span> <span class="n">aij1</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">-</span><span class="n">aij0</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="c1">#sign change needed for loss_function equation</span>
    <span class="n">ajk_</span> <span class="o">=</span> <span class="n">ajk0</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">-</span><span class="n">ajk1</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">angle_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">aij_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">ajk_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)])</span>

    <span class="c1">#following are [N_bonds, N_torsions] arrays comparing if the ij or jk are the same</span>
    <span class="n">ij0</span> <span class="o">=</span> <span class="n">bond_idxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ij1</span> <span class="o">=</span> <span class="n">bond_idxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">jk0</span> <span class="o">=</span> <span class="n">bond_idxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">jk1</span> <span class="o">=</span> <span class="n">bond_idxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">kl0</span> <span class="o">=</span> <span class="n">bond_idxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">kl1</span> <span class="o">=</span> <span class="n">bond_idxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ij_jk_kl</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">ij0</span><span class="o">+</span><span class="n">ij1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">jk0</span><span class="o">+</span><span class="n">jk1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">kl0</span><span class="o">+</span><span class="n">kl1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">ij_</span> <span class="o">=</span> <span class="n">ij0</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">-</span><span class="n">ij1</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">jk_</span> <span class="o">=</span> <span class="n">jk0</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">-</span><span class="n">jk1</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">kl_</span> <span class="o">=</span> <span class="n">kl0</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">-</span><span class="n">kl1</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">torsion_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ij_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">jk_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">kl_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)])</span>

    <span class="c1">#j-i i-&gt;j</span>
    <span class="c1">#i-j j-&gt;i reverse</span>
    <span class="c1">#k-j j-&gt;k </span>
    <span class="c1">#j-k k-&gt;j reverse</span>
    <span class="c1">#l-k k-&gt;l </span>
    <span class="c1">#k-l l-&gt;k reverse</span>


    <span class="k">if</span> <span class="n">NB</span><span class="o">==</span><span class="s1">&#39;matrix&#39;</span><span class="p">:</span>
        <span class="n">equiv_t</span><span class="o">=</span><span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;equivalences&#39;</span><span class="p">]</span>
        <span class="n">vdw_para</span> <span class="o">=</span> <span class="n">other_parameters</span><span class="p">[</span><span class="s1">&#39;vdw_potential_well_depth&#39;</span><span class="p">]</span>
        <span class="c1">#switch these around so that values point to key</span>
        <span class="n">equiv</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">equiv_t</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">equiv_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">equiv</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">i</span>
        <span class="n">atom_R</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">vdw_para</span><span class="p">[</span><span class="n">equiv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">atom_names</span><span class="p">])</span> <span class="c1">#radius</span>
        <span class="n">atom_e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">vdw_para</span><span class="p">[</span><span class="n">equiv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">atom_names</span><span class="p">])</span> <span class="c1">#welldepth</span>
        <span class="c1">#cdist is easier to work with than pdist, batch pdist doesn&#39;t seem to exist too</span>
        <span class="n">vdw_R</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">atom_R</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">atom_R</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vdw_e</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom_e</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">atom_e</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="c1">#set 1-2, and 1-3 distances to 0.0</span>
        <span class="n">vdw_R</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">bond_idxs</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">vdw_e</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">bond_idxs</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">vdw_R</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">angle_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">vdw_e</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">angle_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">correct_1_4</span><span class="p">:</span>
            <span class="c1"># sum A/R**12 - B/R**6; A = e* (R**12); B = 2*e *(R**6)</span>
            <span class="c1"># therefore scale vdw by setting e /= 2.0</span>
            <span class="c1">#vdw_R[list(torsion_idxs[:,(0,3)].T)]/=2.0</span>
            <span class="n">vdw_e</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span><span class="o">/=</span><span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vdw_R</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>
            <span class="n">vdw_e</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">vdw_R</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vdw_R</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">vdw_e</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vdw_e</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>

        <span class="c1">#partial charges are given as fragments of electron charge.</span>
        <span class="c1">#Can convert coulomb energy into kcal/mol by multiplying with 332.05.</span>
        <span class="c1">#therofore multiply q by sqrt(332.05)=18.22 </span>
        <span class="n">e_</span><span class="o">=</span><span class="mf">1.0</span> <span class="c1">#permitivity </span>
        <span class="n">atom_charges</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">atom_charges</span><span class="p">)</span>
        <span class="n">q1q2</span><span class="o">=</span><span class="p">(</span><span class="n">atom_charges</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">atom_charges</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">e_</span><span class="p">)</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#Aij=bi*bj</span>
        <span class="n">q1q2</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">bond_idxs</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">q1q2</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">angle_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">correct_1_4</span><span class="p">:</span>
            <span class="n">q1q2</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span><span class="o">/=</span><span class="mf">1.2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q1q2</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">torsion_idxs</span><span class="p">[:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="c1">#1-4 are should be included but scaled</span>
        <span class="k">return</span> <span class="p">(</span>
                <span class="n">bond_idxs</span><span class="p">,</span> <span class="n">bond_para</span><span class="p">,</span>
                <span class="n">angle_idxs</span><span class="p">,</span> <span class="n">angle_para</span><span class="p">,</span> <span class="n">angle_mask</span><span class="p">,</span> <span class="n">ij_jk</span><span class="p">,</span>
                <span class="n">torsion_idxs</span><span class="p">,</span> <span class="n">torsion_para</span><span class="p">,</span> <span class="n">torsion_mask</span><span class="p">,</span> <span class="n">ij_jk_kl</span><span class="p">,</span>
                <span class="n">vdw_R</span><span class="p">,</span> <span class="n">vdw_e</span><span class="p">,</span>
                <span class="n">q1q2</span><span class="p">,</span>
               <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
            <span class="n">bond_idxs</span><span class="p">,</span> <span class="n">bond_para</span><span class="p">,</span>
            <span class="n">angle_idxs</span><span class="p">,</span> <span class="n">angle_para</span><span class="p">,</span> <span class="n">angle_mask</span><span class="p">,</span> <span class="n">ij_jk</span><span class="p">,</span>
            <span class="n">torsion_idxs</span><span class="p">,</span> <span class="n">torsion_para</span><span class="p">,</span> <span class="n">torsion_mask</span><span class="p">,</span> <span class="n">ij_jk_kl</span><span class="p">,</span>
           <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;../&#39;</span><span class="p">))</span>
    <span class="kn">import</span> <span class="nn">biobox</span>


</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">molearn 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">torch_potential.protein_handler</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, V. K. Ramaswamy, S. C. Musson, M. T. Degiacomi.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>